# Railway 持久化存储配置（5 分钟搞定）

## 🎯 目标

让白板数据在重新部署后不会丢失。

## 📋 配置步骤

### 1️⃣ 打开 Railway 项目

访问：https://railway.app/dashboard

找到你的 `whiteboard-for-agents` 项目并点击进入

### 2️⃣ 进入服务设置

1. 点击你的服务（应该显示为 main 或 whiteboard-for-agents）
2. 点击顶部导航栏的 **"Settings"**（设置）

### 3️⃣ 添加 Volume

1. 在 Settings 页面向下滚动，找到 **"Volumes"** 部分
2. 点击 **"+ New Volume"** 按钮

### 4️⃣ 填写配置

在弹出的对话框中填写：

| 字段 | 填写内容 | 说明 |
|------|----------|------|
| **Mount Path** | `/data` | 必须填这个，不要改 |
| **Size** | `1` GB | 1GB 足够存储大量文本 |

点击 **"Add"** 确认

### 5️⃣ 等待重新部署

- Volume 创建后，Railway 会自动触发重新部署
- 等待 2-3 分钟，直到部署完成（状态变为绿色 ✅）

### 6️⃣ 验证配置成功

打开部署日志（Deployments → 点击最新部署 → View Logs），查找：

```
数据存储路径: /data/whiteboards
使用 Railway Volume: true
```

✅ 看到 `使用 Railway Volume: true` 就成功了！

## 🧪 测试持久化

### 写入测试数据

```bash
curl -X POST https://whiteboard-for-agents-production.up.railway.app/api/whiteboard/main-board/update \
  -H "Content-Type: application/json" \
  -d '{"content": "测试数据 - 如果重新部署后这条消息还在，说明持久化成功！\n\n时间: '$(date +%Y-%m-%d\ %H:%M:%S)'"}'
```

### 手动触发重新部署

1. 在 Railway 控制台，进入 **Deployments** 标签
2. 点击最新的部署
3. 点击右上角的 **"Redeploy"**
4. 等待部署完成

### 验证数据还在

```bash
curl https://whiteboard-for-agents-production.up.railway.app/api/whiteboard/main-board
```

如果看到刚才写入的"测试数据"，说明持久化成功！🎉

## ❓ 常见问题

### Q: 我找不到 "Volumes" 选项

**A**: 确保你：
1. 点击的是服务（Service），不是项目
2. 在 "Settings" 标签页，不是 "Variables"
3. 向下滚动到底部

### Q: 日志显示 `使用 Railway Volume: false`

**A**: 可能的原因：
1. Volume 未成功创建 → 重新创建
2. Mount Path 填错了 → 必须是 `/data`
3. 需要重新部署 → 手动触发 Redeploy

### Q: 已经配置了，但数据还是丢失

**A**: 检查：
1. 确认日志显示 `使用 Railway Volume: true`
2. 确认存储路径是 `/data/whiteboards`
3. 尝试删除 Volume 重新创建

## 💰 费用说明

- **Railway 免费计划**: 包含一定的 Volume 存储额度
- **1GB Volume**: 通常在免费额度内
- **超出限制**: 会有提示，可以升级计划

## 🔄 已完成的代码修改

你不需要修改任何代码！我已经更新了服务器代码：

```javascript
// 自动检测并使用 Railway Volume
const DATA_DIR = process.env.RAILWAY_VOLUME_MOUNT_PATH
  ? path.join(process.env.RAILWAY_VOLUME_MOUNT_PATH, 'whiteboards')
  : path.join(__dirname, 'data');
```

代码会自动：
- ✅ 检测 Volume 是否存在
- ✅ 优先使用 Volume 存储（持久化）
- ✅ 回退到本地存储（临时）

## 📝 完成检查清单

- [ ] 已在 Railway 创建 Volume（Mount Path: `/data`）
- [ ] 已完成重新部署
- [ ] 日志显示 `使用 Railway Volume: true`
- [ ] 测试写入数据
- [ ] 测试重新部署后数据仍然存在

全部打勾，你就完成了！🎊

## 🆘 需要帮助？

如果遇到问题：
1. 检查 Railway 日志中的错误信息
2. 确认 Volume Mount Path 是 `/data`
3. 尝试删除 Volume 重新创建
4. 查看详细文档：`RAILWAY-VOLUME-SETUP.md`
